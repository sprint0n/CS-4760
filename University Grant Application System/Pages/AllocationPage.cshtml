@page
@model University_Grant_Application_System.Pages.AllocationPageModel
@{
    ViewData["Title"] = "Allocation Page";
    Layout = "_CommitteeLayout";
}
<style>
    .input-warning {
        margin-top: 4px;
        font-size: 0.8rem;
        color: #b30000;
        background: #ffe6e6;
        padding: 3px 6px;
        border-radius: 4px;
    }

    .unsaved-warning {
        font-size: 0.9rem;
        color: #b30000;
        background: #ffe6e6;
        padding: 6px 10px;
        border-radius: 4px;
        display: none;
        white-space: nowrap;
    }

</style>


<h1>Allocation Page</h1>

<!-- Money totals -->
<div class="row mb-4">
    <div class="col-md-4">
        <label class="form-label">Total Money Available</label>
        <input value="@Model.TotalMoneyAvailable.ToString("C")" class="form-control" readonly />
    </div>
    <div class="col-md-4">
        <label class="form-label">Total Money Requested (RSPG Totals)</label>
        <input value="@Model.TotalMoneyRequested.ToString("C")" class="form-control" readonly />
    </div>
</div>

<!-- Criteria Ranges Filters -->
<div class="row mb-4">

    <!-- FULL FUNDING -->
    <div class="col-md-3">
        <div class="d-flex align-items-end gap-1">
            <div class="flex-grow-1">
                <label for="fullFunds" class="form-label">Full Funding Score Criteria</label>
                <div class="input-group">
                    <input class="form-control" value="90" min="0" max="100" id="fullFunds" />
                    <span class="input-group-text">%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PARTIAL FUNDING -->
    <div class="col-md-3">
        <div class="d-flex align-items-end gap-1">
            <div class="flex-grow-1">
                <label for="partialFunds1" class="form-label">Partial Funding Score Criteria</label>
                <div class="input-group">
                    <input class="form-control" value="80" min="0" max="100" id="partialFunds1" />
                    <span class="input-group-text">%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- NO FUNDING -->
    <div class="col-md-3">
        <div class="d-flex align-items-end gap-1">
            <div class="flex-grow-1">
                <label for="scoreFilter" class="form-label">No Funding Score Criteria</label>
                <div class="input-group">
                    <input class="form-control" value="70" min="0" max="100" id="scoreFilter" />
                    <span class="input-group-text">%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- APPLY ALL BUTTON -->
<div class="row mb-4">
    <div class="col-md-12 d-flex justify-content-center">
        <div class="d-flex align-items-center gap-3">
            <!-- Fixed-size centered button -->
            <button id="applyAllFunding" class="btn btn-primary" style="width: 260px;">
                Apply All Funding Criteria
            </button>

            <!-- Unsaved changes warning -->
            <div id="unsavedWarning" class="unsaved-warning">
                Changes detected — click Apply
            </div>
        </div>
    </div>
</div>




<!-- Visible count -->
<div class="row mb-4">
    <div class="col-md-6">
        <span id="visibleCount" class="fw-bold">0</span> of
        <span id="totalCount" class="fw-bold">0</span> receive funding
    </div>
</div>

<!-- OG Table -->
<h4 class="mt-4">Non-sorted Applications</h4>
<table class="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Submitted By</th>
            <th>Principal Investigator</th>
            <th><strong>RSPG Total</strong></th>
            <th>Other Total</th>
            <th>Average Score</th>
            <th>Allocated Funds</th>
        </tr>
    </thead>
    <tbody id="applicationsTableBody">
        @foreach (var app in Model.Applications)
        {
            <tr data-score="@app.OverallScore">
                <td>@app.Title</td>
                <td>@app.SubmittedBy</td>
                <td>@app.PrincipalInvestigator</td>
                <td><strong>@app.RspgTotal.ToString("C")</strong></td>
                <td>@app.OtherTotal.ToString("C")</td>
                <td>@app.OverallScore.ToString("P1")</td>
                <td class="allocated-funds"></td>
            </tr>
        }
    </tbody>
</table>

<!-- FULL FUNDING TABLE -->
<h4 class="mt-4">Full Funding</h4>
<table class="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Submitted By</th>
            <th>Principal Investigator</th>
            <th><strong>RSPG Total</strong></th>
            <th>Other Total</th>
            <th>Average Score</th>
            <th>Allocated Funds</th>
        </tr>
    </thead>
    <tbody id="fullFundingTableBody"></tbody>
</table>


<!-- PARTIAL FUNDING TABLE -->
<h4 class="mt-4">Partial Funding</h4>
<table class="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Submitted By</th>
            <th>Principal Investigator</th>
            <th><strong>RSPG Total</strong></th>
            <th>Other Total</th>
            <th>Average Score</th>
            <th>Allocated Funds</th>
        </tr>
    </thead>
    <tbody id="partialFundingTableBody"></tbody>
</table>


<!-- NO FUNDING TABLE -->
<h4 class="mt-4">No Funding</h4>
<table class="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Submitted By</th>
            <th>Principal Investigator</th>
            <th><strong>RSPG Total</strong></th>
            <th>Other Total</th>
            <th>Average Score</th>
            <th>Allocated Funds</th>
        </tr>
    </thead>
    <tbody id="noFundingTableBody"></tbody>
</table>



@section Scripts {

    <!-- INPUT VALUES SCRIPT -->
    <script>
        const fullFunds = document.getElementById("fullFunds");
        const partial1 = document.getElementById("partialFunds1");
        const noFunds = document.getElementById("scoreFilter");

        const applyAllFundingBtn_UI = document.getElementById("applyAllFunding");
        const unsavedWarning = document.getElementById("unsavedWarning");

        let lastApplied = {
            full: fullFunds.value,
            partial: partial1.value,
            no: noFunds.value
        };

        function showInputWarning(input, message) {
            clearInputWarning(input);
            const warning = document.createElement("div");
            warning.className = "input-warning";
            warning.textContent = message;
            input.parentElement.parentElement.appendChild(warning);
        }

        function clearInputWarning(input) {
            const parent = input.parentElement.parentElement;
            const existing = parent.querySelector(".input-warning");
            if (existing) existing.remove();
        }

        function checkUnsavedChanges() {
            if (
                fullFunds.value !== lastApplied.full ||
                partial1.value !== lastApplied.partial ||
                noFunds.value !== lastApplied.no
            ) {
                unsavedWarning.style.display = "inline-block";
            } else {
                unsavedWarning.style.display = "none";
            }
        }

        function clampToMax(input) {
            const max = parseInt(input.max);
            const value = parseInt(input.value);
            if (!isNaN(value) && value > max) input.value = max;
        }

        function enforceHierarchy() {
            const fullVal = parseInt(fullFunds.value);
            const partialVal = parseInt(partial1.value);
            const noVal = parseInt(noFunds.value);

            if (!isNaN(partialVal) && partialVal >= fullVal) {
                partial1.value = "";
                showInputWarning(partial1, "Cleared: must be lower than Full Funding");
            } else clearInputWarning(partial1);

            if (!isNaN(noVal) && noVal >= fullVal) {
                noFunds.value = "";
                showInputWarning(noFunds, "Cleared: must be lower than Full Funding");
            } else if (noFunds.value !== "") clearInputWarning(noFunds);

            const newPartialVal = parseInt(partial1.value);
            const newNoVal = parseInt(noFunds.value);

            if (!isNaN(newNoVal) && !isNaN(newPartialVal) && newNoVal >= newPartialVal) {
                noFunds.value = "";
                showInputWarning(noFunds, "Cleared: must be lower than Partial Funding");
            }
        }

        function updateMaxValues() {
            enforceHierarchy();

            const fullVal = parseInt(fullFunds.value);
            const partialVal = parseInt(partial1.value);

            partial1.max = fullVal - 1;
            noFunds.max = !isNaN(partialVal) ? partialVal - 1 : fullVal - 2;

            clampToMax(partial1);
            clampToMax(noFunds);

            checkUnsavedChanges();
        }

        applyAllFundingBtn_UI.addEventListener("click", () => {
            updateMaxValues(); // enforce hierarchy BEFORE funding logic runs

            lastApplied = {
                full: fullFunds.value,
                partial: partial1.value,
                no: noFunds.value
            };

            unsavedWarning.style.display = "none";
        });

        fullFunds.addEventListener("change", updateMaxValues);
        partial1.addEventListener("change", updateMaxValues);
        noFunds.addEventListener("change", updateMaxValues);

        partial1.addEventListener("input", () => { clampToMax(partial1); checkUnsavedChanges(); });
        noFunds.addEventListener("input", () => { clampToMax(noFunds); checkUnsavedChanges(); });

        updateMaxValues();
    </script>

    <!-- APPLY FUNDING SCRIPT -->
    <script>
        const applyAllFundingBtn_FUNDING = document.getElementById("applyAllFunding");

        const fullFundingInput = document.getElementById("fullFunds");
        const partialFundingInput = document.getElementById("partialFunds1");
        const noFundingInput = document.getElementById("scoreFilter");

        const sourceBody = document.getElementById("applicationsTableBody");
        const fullFundingBody = document.getElementById("fullFundingTableBody");
        const partialFundingBody = document.getElementById("partialFundingTableBody");
        const noFundingBody = document.getElementById("noFundingTableBody");

        const totalCountEl = document.getElementById("totalCount");
        const visibleCountEl = document.getElementById("visibleCount");

        function moveRow(row, targetBody) {
            if (row.parentElement !== targetBody) targetBody.appendChild(row);
        }

        function setAllocatedFunds(row, value) {
            const cell = row.querySelector(".allocated-funds");
            if (cell) cell.textContent = value;
        }

        function getRspgTotal(row) {
            const rspgCell = row.querySelector("td:nth-child(4)");
            return rspgCell ? rspgCell.textContent.trim() : "";
        }

        function calculatePartialFundingAmount(row) {
            const numeric = parseFloat(getRspgTotal(row).replace(/[^0-9.-]+/g, ""));
            return (numeric * 0.9).toLocaleString("en-US", { style: "currency", currency: "USD" });
        }

        function getAllRows() {
            return document.querySelectorAll(
                "#applicationsTableBody tr, #fullFundingTableBody tr, #partialFundingTableBody tr, #noFundingTableBody tr"
            );
        }

        function updateCounts() {
            const total = getAllRows().length;
            const visible = total - noFundingBody.querySelectorAll("tr").length;
            totalCountEl.textContent = total;
            visibleCountEl.textContent = visible;
        }

        function applyAllFundingCriteria() {
            const fullThreshold = parseFloat(fullFundingInput.value);
            const partialThreshold = parseFloat(partialFundingInput.value);
            const noFundingThreshold = parseFloat(noFundingInput.value);

            getAllRows().forEach(row => {
                const rowScore = parseFloat(row.getAttribute("data-score") * 100);

                if (rowScore < noFundingThreshold) {
                    moveRow(row, noFundingBody);
                    setAllocatedFunds(row, "$0");
                    return;
                }

                if (rowScore >= fullThreshold) {
                    moveRow(row, fullFundingBody);
                    setAllocatedFunds(row, getRspgTotal(row));
                    return;
                }

                if (rowScore >= partialThreshold && rowScore < fullThreshold) {
                    moveRow(row, partialFundingBody);
                    setAllocatedFunds(row, calculatePartialFundingAmount(row));
                    return;
                }

                moveRow(row, sourceBody);
                setAllocatedFunds(row, "");
            });

            updateCounts();
        }

        applyAllFundingBtn_FUNDING.addEventListener("click", applyAllFundingCriteria);

        updateCounts();
    </script>







}